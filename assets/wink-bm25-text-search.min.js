var helpers=require("wink-helpers"),bm25fIMS=function(){var r,e=[],n=Object.create(null),t=Object.create(null),i=Object.create(null),o=[],a=[],s=!1,l=!1,f=0,c=0,u=0,d=null,h=Object.create(null),b=0,m=function(t,i){for(var o=t,a=n[i]&&n[i].pTasks||e,s=n[i]&&n[i].pTaskCount||r,l=0;l<s;l+=1)o=a[l](o);return o},g=function(r,e,n,t,i){for(var a,s=m(e,i),l=0,f=s.length;l<f;l+=1)a=s[l],void 0===h[a]&&(h[a]=b,b+=1),void 0===t[a=h[a]]?(t[a]=n,o[a]=o[a]||[],o[a].push(r)):t[a]+=n;return s.length*Math.abs(n)},p=function(r,e){if(null===d)throw Error("winkBM25S: Config must be defined before adding a document.");var n,t=d.fldWeights;if(l)throw Error("winkBM25S: post consolidation adding/learning is not possible!");if(s=!0,void 0!==i[e])throw Error("winkBM25S: Duplicate document encountered: "+JSON.stringify(e));for(var o in i[e]=Object.create(null),i[e].freq=Object.create(null),i[e].fieldValues=Object.create(null),i[e].length=0,t){if(void 0===r[o])throw Error("winkBM25S: Missing field in the document: "+JSON.stringify(o));n=g(e,r[o],t[o],i[e].freq,o),i[e].length+=n,c+=n}return d.ovFldNames.forEach((function(n){if(void 0===r[n])throw Error("winkBM25S: Missing field in the document: "+JSON.stringify(n));i[e].fieldValues[n]=r[n]})),f+=1},k=function(r,e,n,t){if(!l)throw Error("winkBM25S: search is not possible unless learnings are consolidated!");if("string"!=typeof r)throw Error("winkBM25S: search text should be a string, instead found: "+typeof r);var a,s,f,c,u,d,b,g="function"==typeof n?n:function(){return!0},p=m(r,"search").filter((function(r){return void 0!==h[r]})).map((function(r){return h[r]})),k=Object.create(null);for(d=0,b=p.length;d<b;d+=1)for(f=p[d],c=0,u=(s=o[f]).length;c<u;c+=1)a=s[c],g(i[a].fieldValues,t)&&(k[a]=i[a].freq[f]+(k[a]||0));return helpers.object.table(k).sort(helpers.array.descendingOnValue).slice(0,Math.max(e||10,1))},w=function(){return i=Object.create(null),o=[],a=[],s=!1,l=!1,f=0,c=0,u=0,d=null,h=Object.create(null),b=0,!0};return t.definePrepTasks=function(t,i){if(null===d)throw Error("winkBM25S: Config must be defined before defining prepTasks.");if(!helpers.array.isArray(t))throw Error("winkBM25S: Tasks should be an array, instead found: "+JSON.stringify(t));for(var o=0,a=t.length;o<a;o+=1)if("function"!=typeof t[o])throw Error("winkBM25S: Tasks should contain function, instead found: "+typeof t[o]);var s=d.fldWeights;if(null==i)e=t,r=t.length;else{if(!s[i]||"string"!=typeof i)throw Error("winkBM25S: Field name is missing or it is not a string: "+JSON.stringify(i)+"/"+typeof i);n[i]=n[i]||Object.create(null),n[i].pTasks=t,n[i].pTaskCount=t.length}return t.length},t.defineConfig=function(r){if(s)throw Error("winkBM25S: config must be defined before learning/addition starts!");if(!helpers.object.isObject(r))throw Error("winkBM25S: config must be a config object, instead found: "+JSON.stringify(r));if(!helpers.object.isObject(r.fldWeights))throw Error("winkBM25S: fldWeights must be an object, instead found: "+JSON.stringify(r.fldWeights));if(0===helpers.object.keys(r.fldWeights).length)throw Error("winkBM25S: Field config has no field defined.");for(var e in(d=Object.create(null)).fldWeights=Object.create(null),d.bm25Params=Object.create(null),d.bm25Params.k1=1.2,d.bm25Params.b=.75,d.bm25Params.k=1,r.fldWeights){if(!r.fldWeights[e]||isNaN(r.fldWeights[e]))throw Error("winkBM25S: Field weight should be number >0, instead found: "+JSON.stringify(r.fldWeights[e]));d.fldWeights[e]=+r.fldWeights[e]}if(helpers.object.isObject(r.bm25Params)||(r.bm25Params=Object.create(null)),d.bm25Params.b=null===r.bm25Params.b||void 0===r.bm25Params.b||isNaN(r.bm25Params.b)||+r.bm25Params.b<0||+r.bm25Params.b>1?.75:+r.bm25Params.b,d.bm25Params.k1=null===r.bm25Params.k1||void 0===r.bm25Params.k1||isNaN(r.bm25Params.k1)||+r.bm25Params.k1<0?1.2:+r.bm25Params.k1,d.bm25Params.k=null===r.bm25Params.k||void 0===r.bm25Params.k||isNaN(r.bm25Params.k)||+r.bm25Params.k<0?1:+r.bm25Params.k,d.ovFldNames=[],r.ovFldNames||(r.ovFldNames=[]),!helpers.array.isArray(r.ovFldNames))throw Error("winkBM25S: OV Field names should be an array, instead found: "+JSON.stringify(typeof r.ovFldNames));return r.ovFldNames.forEach((function(r){if("string"!=typeof r||0===r.length)throw Error("winkBM25S: OV Field name should be a non-empty string, instead found: "+JSON.stringify(r));d.ovFldNames.push(r)})),!0},t.addDoc=p,t.getDocs=function(){return i},t.getTokens=function(){return h},t.getConfig=function(){return d},t.getIDF=function(){return a},t.getTotalCorpusLength=function(){return c},t.getTotalDocs=function(){return f},t.consolidate=function(r){if(l)throw Error("winkBM25S: consolidation can be carried out only once!");if(f<3)throw Error("winkBM25S: document collection is too small for consolidation; add more docs!");var e=parseInt(r,10);e=isNaN(e)||e<4?4:e>9?9:e;for(var n,t,s,h,b,m=d.bm25Params.b,g=d.bm25Params.k1,p=d.bm25Params.k,k=0,w=o.length;k<w;k+=1)s=o[k].length,a[k]=Math.log((f-s+.5)/(s+.5)+p);for(t in u=c/f,i)for(b in h=1-m+m*(i[t].length/u),i[t].freq)n=i[t].freq[b],i[t].freq[b]=Math.sign(n)*(Math.abs(n*(g+1)/(g*h+n))*a[b]).toFixed(e);return l=!0,!0},t.search=k,t.exportJSON=function(){var r=Object.create(null);return r.totalCorpusLength=c,r.totalDocs=f,r.consolidated=l,JSON.stringify([d,r,i,o,b,h,{},[],[]])},t.importJSON=function(r){if(!r)throw Error("winkBM25S: undefined or null JSON encountered, import failed!");var e=[helpers.object.isObject,helpers.object.isObject,helpers.object.isObject,helpers.array.isArray,Number.isInteger,helpers.object.isObject,helpers.object.isObject,helpers.array.isArray,helpers.array.isArray],n=JSON.parse(r);if(!helpers.array.isArray(n)||n.length!==e.length)throw Error("winkBM25S: invalid JSON encountered, can not import.");for(var t=0;t<e.length;t+=1)if(!e[t](n[t]))throw Error("winkBM25S: invalid JSON encountered, can not import.");return w(),s=!0,d=n[0],c=n[1].totalCorpusLength,f=n[1].totalDocs,l=n[1].consolidated,i=n[2],o=n[3],b=n[4],h=n[5],!0},t.reset=w,t.learn=p,t.predict=k,t};module.exports=bm25fIMS;